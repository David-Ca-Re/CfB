%function ExcelToMIDcore('ExcelFile','DoMean','Protocol', 'DataFile','IonArg')

    ExcelFile='20190613_Results_flux_Ivan-COPY.xlsx';
    Protocol='LC-MS1';
    DoMean=1;
    IonArg=1;
    DataFile='ExcelToMIDcore-RawDataInfo.xlsx';
    
    T = readtable(ExcelFile, 'Sheet',1);
    [rown, colLength]=size(T);
    molecules_info=readtable(DataFile,'Sheet',1);
    shortFormName=molecules_info(:,1);
    %Vector amb les condicions
     
    %To replace 'N/A' by '0'
    T2=table2array(T);
    [a1, b1]=size(T2);
    Data1=T;
    [a2, b2]=size(Data1);
    Data2=Data1;
    for j=1:rown
        for i=1:colLength
           Data2{j,i}=replace(Data1{j,i},'N/A','0');
        end
    end
    


    

    %Commer checking and Data Arrangements, NewTable will be the new table
    %with the correct data to work with
    
    experiments=Data2{:,2};
    %This will extract the commercial line
    commercial=Data2(not(cellfun(@isempty,regexp(experiments,'$commer'))),:);
    newTable1 = Data2(not(cellfun(@isempty,regexp(experiments,'-1$'))),:);
    newTable2 = Data2(cellfun(@isempty,regexp(experiments,'-1$')),:);
    if isempty(commercial)==1
        NewTable = [newTable1; newTable2(3:end,:)];
    elseif isempty(commercial)==0
        NewTable = [commercial; newTable1; newTable2(3:end,:)];
    end
    
    %Mean calculations if required
    expHeaders=NewTable(:,2);
    NameUnique=unique(expHeaders);
    Data=NewTable(:,5:end);
    DataArray=Data{:,:};
    if DoMean==1
        Means=zeros(height(NameUnique),width(Data));
        for replicates=1:height(NameUnique)
            DataLineCell=table2cell(Data(ismember(expHeaders,NameUnique(replicates,1)),:));
            for columns=1:width(Data)
                AmountReplicates=height(expHeaders)/height(NameUnique);
                position=find(ismember(expHeaders,NameUnique(replicates,1)))/AmountReplicates;
                Means(position(2),columns)=mean(cellfun(@str2num ,DataLineCell(:,columns),'UniformOutput',1));
            end
        end
        %ExpTitles=array2table(zeros(height(NameUnique),1));
        pos2=1:1:height(NameUnique);
        pos=1:AmountReplicates:height(expHeaders);
        ExpTitles(pos2,1)=expHeaders(pos,1);   
        MeanTable=[ExpTitles array2table(Means)];
    end

    %To clean the names of the molecules
    moleculesUnique=unique(table2cell(Data2(1,5:colLength)));
    moleculesInChar=char(moleculesUnique);
    for i=1:length(moleculesUnique)
        splitted=split(moleculesUnique{1,i},'-');
        molUniqueModified(i,1)=lower(splitted(1));
    end
    
    %To extract each molecule in an txt file
    excel_title=Data2{1,1:colLength};
    A=zeros(rown,1);
    %for i=1:length(moleculesUnique)
    for i=1
        molecule=strip(moleculesInChar(i,:)); 


        %HEAD 
        %row is the ismember+protocol in row,12
        %for the rows with 1, another ismember with protocol
        row=ismember(molecule,shortFormName{:,:});
        carbonsNumber=molecules_info{row,3};
        fragment=molecules_info{row,10};
        sulfurNumber=molecules_info{row,5};
        siliciumNumber=molecules_info{row,6};
        mz=zeros(1,carbonsNumber+1);
        mz(1,1)=molecules_info{row,2};
        for value=2:carbonsNumber+1
             mz(1,value)=mz(1,value-1)+1;
        end


        %BODY
        if DoMean==0
            A=NewTable(:,ismember(excel_title(1,5:end),molecule));
            newExpTitles=expHeaders;
        elseif DoMean==1
            A=Means(:,ismember(excel_title(1,5:end),molecule));
            newExpTitles=ExpTitles;
        end   
        %A_final=[newExpTitles table(A)];
        %This creates a string array
        A_final=[string(newExpTitles{:,:}) A];
       
        
        
       %Check if there is no row with commer data or the row are zeros in
       %order to generate the commer asuming a Binomial Distribution
        if isempty(commercial)==1 || commercial(1,1)==0
            %This is the case where there is no row on commer (like in LC)
            x=0:(carbonsNumber);
            pdf1=binopdf(x,carbonsNumber,0.01); %1% of carbon is labelled
            commer=zeros(1,1);
            commer(1)=pdf1(1)*mean(cellfun(@str2num, newTable1{:,5}));
            for i=2:length(pdf1)
                commer(i)=(pdf1(i)*commer(1))/pdf1(1);
            end
            commer_vector=table(zeros(1,1));
            for ii=1:length(commer)
                commer_vector{1,ii}=commer(ii)
            end
            commer_line=sprintf(['commer','\t',num2str(commer)]);
            
        end
        %cellstr(commer_line)
        
        
        %IONIZATION
        if IonArg==1
            %Positive
            %Amount=
        elseif IonArg==0
            %Negative
        end
        

        
        
        %TO PRINT IN AN OUTFILE

        %To print into a txt file if is all 1 table
        molName=strcat(molecule,".txt");
        writetable(Head,molName,'Delimiter','\t','WriteRowNames',false);
        fclose(molName);
        
    
        %THIS FIRST WORKS
        fileID = fopen(molName,"w");
        [rown, coln]=size(Head)
        for row = 1:rown
            fprintf(fileID,"%s \t %s \n",string(Head{row,:}));
        end
        fclose("all")
        
        %NEED TO CONVERT BODY HEADER TO A table
        fileID = fopen(molName,"a")
        [rown, coln]=size(BodyHeader)
        for row = 1:rown
            fprintf(fileID,"%s \t",string(BodyHeader{row,:}));
        end
        fclose("all")
        
        %https://se.mathworks.com/help/matlab/import_export/write-to-delimited-data-files.html
        %Metabolite list complete_updated_SS
        %GC to convert MID_Xcalibur
    end
